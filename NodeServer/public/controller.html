<!-- 
    
-->

<!DOCTYPE html>
<html>
    <head>
        <title>user Test</title>
        <meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="css/reset.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
    </head>

    <body>
        <div id="Experiment_Section" class="section">
            <button id="Exp_New_B" class="threeAcross">New Experiment</button>
            <button id="Exp_End_B" class="threeAcross">End Experiment</button>
            <button id="Debug_B" class="threeAcross">Debug Toggle</button>
        </div>
        <div id="Live_Section">
            <div id="DisplayWrapper">
                <div id="Display">
                    <div class="pillarButton" style="top:10.00%; left:50.00%;"></div>
                    <div class="pillarButton" style="top:15.36%; left:70.00%;"></div>
                    <div class="pillarButton" style="top:30.00%; left:84.64%;"></div>

                    <div class="pillarButton" style="top:50.00%; left:90.00%;"></div>
                    <div class="pillarButton" style="top:70.00%; left:84.64%;"></div>
                    <div class="pillarButton" style="top:84.64%; left:70.00%;"></div>

                    <div class="pillarButton" style="top:90.00%; left:50.00%;"></div>
                    <div class="pillarButton" style="top:84.64%; left:30.00%;"></div>
                    <div class="pillarButton" style="top:70.00%; left:15.36%;"></div>

                    <div class="pillarButton" style="top:50.00%; left:10.00%;"></div>
                    <div class="pillarButton" style="top:30.00%; left:15.36%;"></div>
                    <div class="pillarButton" style="top:15.36%; left:30.00%;"></div>
                </div>
            </div>
        </div>
        <div id="Mode_Section" class="section">
            <button id="Mode_Avatar_B" class="threeAcross">Avatar</button>
            <button id="Mode_BB_B" class="threeAcross">Bounding Box</button>
            <button id="Mode_Hybrid_B" class="threeAcross">Hybrid</button>
        </div>
        <div id="Trial_Section" class="section">
            <button id="Trial_New_B" class="oneAcross">New Trial</button>
        </section>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            const LERP_VAL 	        = 0.5;
            let userID 		        = "";
            let socket 		        = io();
            let initialized         = false;
            let usersArr 	        = new Array();
            let selectedUserID      = "";

            //just some consts for typed array access
            const R = 0;
            const G = 1;
            const B = 2;

            const X = 0;
            const Y = 1;
            const Z = 2;
            const W = 3;

            const MODE_AVATAR       = 0;
            const MODE_BOUNDINGBOX  = 1;
            const MODE_HYBRID       = 2;

            const CLICK_COLOR       = "rgba(0, 0, 255, 1.0)";

            function getUserObj(id,

                        r, g, b,

                        root_pos_x, root_pos_y, root_pos_z,
                        head_pos_x, head_pos_y, head_pos_z,
                        hand_L_pos_x, hand_L_pos_y, hand_L_pos_z,
                        hand_R_pos_x, hand_R_pos_y, hand_R_pos_z,

                        root_rot_w, root_rot_x, root_rot_y, root_rot_z,
                        head_rot_w, head_rot_x, head_rot_y, head_rot_z,
                        hand_L_rot_w, hand_L_rot_x, hand_L_rot_y, hand_L_rot_z,
                        hand_R_rot_w, hand_R_rot_x, hand_R_rot_y, hand_R_rot_z,

                        message) {
                let userObj = {};

                userObj.id = id;
                userObj.color = [r, g, b];

                userObj.pos_root = [root_pos_x, root_pos_y, root_pos_z];
                userObj.pos_head = [head_pos_x, head_pos_y, head_pos_z];
                userObj.pos_hand_L = [hand_L_pos_x, hand_L_pos_y, hand_L_pos_z];
                userObj.pos_hand_R = [hand_R_pos_x, hand_R_pos_y, hand_R_pos_z];

                userObj.rot_root = [root_rot_x, root_rot_y, root_rot_z, root_rot_w];
                userObj.rot_head = [head_rot_x, head_rot_y, head_rot_z, head_rot_w];
                userObj.rot_hand_L = [hand_L_rot_x, hand_L_rot_y, hand_L_rot_z, hand_L_rot_w];
                userObj.rot_hand_R = [hand_R_rot_x, hand_R_rot_y, hand_R_rot_z, hand_L_rot_w];

                userObj.message = message;

                return userObj;
            }

            function map(value, in_min, in_max, out_min, out_max, doClamp)
            {
                let val = (value - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
                if (doClamp) {
                    val = Math.min( Math.max(val, out_min), out_max );
                }
                return val;
            }

            function lerp(start, end, percent)
            {
                return (start + percent * (end - start));
            }

            socket.on("connect", (userData) => {
                socket.emit("newController");
            });

            socket.on("usersData", (data) => {
                usersArr = [...data.items];

				//add any users already present before we start updating them
                if ( userID !== "" && initialized === false ) {
                    for (let i = 0; i < usersArr.length; i++) {
                        addUser(usersArr[i]);
                    }
                    initialized = true;	//lets not do this more than once ;)
                }
            });

            socket.on("connection_setID", (userData) => {
                if ( userID === "" ) {
                    userID = userData.id;
                    console.log( "id received: " + userID );
                }
            });

            socket.on("user_connect", (userData) => {
                console.log("user_connect: " + userData.id);
                addUser(userData);
            });

            socket.on("user_disconnect", (userData) => {
                console.log("user_disconnect: " + userData.id);
                removeUser(userData);
            });

            socket.on("setAvatarMode", (data) => {
                console.log("set display mode: " + data);
                changeAvatarMode(data);
            });

            function changeAvatarMode(mode) {
                switch (mode) {
                    case MODE_AVATAR: {
                        $(".userHead").show();
                        $(".userBody").show();
                        $(".userBoundingBox").hide();
                    }
                    break;
                    case MODE_BOUNDINGBOX: {
                        $(".userHead").hide();
                        $(".userBody").hide();
                        $(".userBoundingBox").show();

                    }
                    break;
                    case MODE_HYBRID: {
                        $(".userHead").show();
                        $(".userBody").show();
                        $(".userBoundingBox").show();
                    }
                    break;
                };
            }

            function removeUser(userObj) 
            {
                let userElemArr = $(".userElem").toArray();
                for (let i = userElemArr.length; i >= 0; i--) {
                    let elem = $(userElemArr[i]);
                    if ( elem.attr("id") === userObj.id ) {
                        elem.remove();
                        break;
                    }
                }
            }

            function addUser(userObj) 
            {
                const userColorStr = "rgb(" + userObj.color[R] + "," + userObj.color[G] + "," + userObj.color[B] + ")";

                //create main user element
                let newUserElem = document.createElement('div');
                $(newUserElem).attr("id", userObj.id);
                $(newUserElem).addClass("userElem");
                $(newUserElem).appendTo("#Display");

                //create user boundingbox element
                let newBoundingBox = document.createElement('div');
                $(newBoundingBox).addClass("userBoundingBox"); //remove / add
                $(newBoundingBox).css("box-shadow", "inset 0vw 0vw 0vw 1vw " + userColorStr);
                $(newUserElem).append( $(newBoundingBox) );

                //create user avatar element
                let newUserHead = document.createElement('div');
                $(newUserHead).addClass("userHead");
                $(newUserHead).css("background-color", userColorStr);
                $(newUserElem).append( $(newUserHead) );

                let newUserBody = document.createElement('div');
                $(newUserBody).addClass("userBody");
                $(newUserBody).css("background-color", userColorStr);
                $(newUserElem).append( $(newUserBody) );

                $(newUserElem).click( (event) => {
                    selectedUserJNode = $(newUserElem).attr("id");
                    $(".userElem").css("background-color", "rgba(0, 0, 0, 0)");
                    $(newUserElem).css("background-color", "rgba(252, 235, 2, 0.5)");
                });
            }

            //doc ready, let's send our movement
            $(document).ready( () => {

                //set up buttons
                //new experiment
                $("#Exp_New_B").click( (event) => {
                    
                });

                //end experiment
                $("#Exp_End_B").click( (event) => {

                });

                //debug toggle
                $("#Debug_B").click( (event) => {

                });

                //avatar mode
                $("#Mode_Avatar_B").click( (event) => {
                    $("#Mode_Avatar_B").css("background-color", "#cacaca");
                    $("#Mode_BB_B").css("background-color", "#727272");
                    $("#Mode_Hybrid_B").css("background-color", "#727272");

                    socket.emit("modeChange", MODE_AVATAR);
                });

                //boundingBox mode
                $("#Mode_BB_B").click( (event) => {
                    $("#Mode_Avatar_B").css("background-color", "#727272");
                    $("#Mode_BB_B").css("background-color", "#cacaca");
                    $("#Mode_Hybrid_B").css("background-color", "#727272");

                    socket.emit("modeChange", MODE_BOUNDINGBOX);
                });

                //hybrid mode
                $("#Mode_Hybrid_B").click( (event) => {
                    $("#Mode_Avatar_B").css("background-color", "#727272");
                    $("#Mode_BB_B").css("background-color", "#727272");
                    $("#Mode_Hybrid_B").css("background-color", "#cacaca");

                    socket.emit("modeChange", MODE_HYBRID);
                });

                $("#Mode_Hybrid_B").click(); //default at hybrid mode

                //new trial
                $("#Trial_New_B").click( (event) => {

                });

                //set up pillars
                $(".pillarButton").each( (index, obj) => {
                    let pillarButton = $(obj);
                    pillarButton.attr("prev-background-color", "");

                    pillarButton.click( () => {
                        if ( pillarButton.attr("prev-background-color") === "" ) {
                            console.log("click ON");
                            pillarButton.attr("prev-background-color", pillarButton.css("background-color"));
                            pillarButton.css("background-color", CLICK_COLOR);
                        }
                        else {
                            console.log("click OFF");
                            pillarButton.css("background-color", pillarButton.attr("prev-background-color"));
                            pillarButton.attr("prev-background-color", "");
                        }
                    });
                });
                
                //"game loop" update/draw code
                setInterval(update, 1000/60);
                function update() 
                {
               		for ( let i = 0; i < usersArr.length; i++ ) {
                    	let userObj                 = usersArr[i];

                       	//first check if there is element exist, and update if so
                       	$(".userElem").each( (index, obj) => {
                        		let elem = $(obj);
                            		if ( elem.attr("id") === userObj.id ) {
                                		const scalar_x = $("#Display").width() - $(".userElem").first().width();
                                        const scalar_y = $("#Display").height() - $(".userElem").first().height();
                                        const oldX = parseInt(elem.css("left"), 10); //need tyo use parseInt with base10 to remove 'px' given by css attr. call
                                        const oldY = parseInt(elem.css("top"), 10);
                                        const newX = lerp(oldX, userObj.pos_head[X] * scalar_x, LERP_VAL);
                                        const newY = lerp(oldY, userObj.pos_head[Z] * scalar_y, LERP_VAL);
                                        elem.css("left", newX);
                                        elem.css("top", newY);
                              	}
                     	});
              		}
             	}

              	//close event
               	window.onbeforeunload = () => {
                	//event called before page closes
                  	return "Do you really want to close?";
              	};
            });

			// function pointerMove(event) 
			// {
				
			// }

        </script>
    </body>
</html>
