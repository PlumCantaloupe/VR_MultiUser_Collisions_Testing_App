<!DOCTYPE html>
<html>
    <head>
        <title>user Test</title>
        <meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="css/reset.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
    </head>

    <body>
        <div id="Live_Section">
            <div id="DisplayWrapper">
                <div id="Display">
                    <div class="pillarButton" style="top:10.00%;    left:50.00%;"></div>
                    <div class="pillarButton" style="top:15.36%;    left:70.00%;"></div>
                    <div class="pillarButton" style="top:30.00%;    left:84.64%;"></div>

                    <div class="pillarButton" style="top:50.00%;    left:90.00%;"></div>
                    <div class="pillarButton" style="top:70.00%;    left:84.64%;"></div>
                    <div class="pillarButton" style="top:84.64%;    left:70.00%;"></div>

                    <div class="pillarButton" style="top:90.00%;    left:50.00%;"></div>
                    <div class="pillarButton" style="top:84.64%;    left:30.00%;"></div>
                    <div class="pillarButton" style="top:70.00%;    left:15.36%;"></div>

                    <div class="pillarButton" style="top:50.00%;    left:10.00%;"></div>
                    <div class="pillarButton" style="top:30.00%;    left:15.36%;"></div>
                    <div class="pillarButton" style="top:15.36%;    left:30.00%;"></div>
                </div>
            </div>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            const LERP_VAL 	= 0.5;
            let userID 		= "";
            let socket 		= io();
            let initialized = false;
            let usersArr 	= new Array();

            //just some consts for typed array access
            const R = 0;
            const G = 1;
            const B = 2;

            const X = 0;
            const Y = 1;
            const Z = 2;
            const W = 3;

            function getUserObj(id,

                        r, g, b,

                        root_pos_x, root_pos_y, root_pos_z,
                        head_pos_x, head_pos_y, head_pos_z,
                        hand_L_pos_x, hand_L_pos_y, hand_L_pos_z,
                        hand_R_pos_x, hand_R_pos_y, hand_R_pos_z,

                        root_rot_w, root_rot_x, root_rot_y, root_rot_z,
                        head_rot_w, head_rot_x, head_rot_y, head_rot_z,
                        hand_L_rot_w, hand_L_rot_x, hand_L_rot_y, hand_L_rot_z,
                        hand_R_rot_w, hand_R_rot_x, hand_R_rot_y, hand_R_rot_z,

                        message) {
                let userObj = {};

                userObj.id = id;
                userObj.color = [r, g, b];

                userObj.pos_root = [root_pos_x, root_pos_y, root_pos_z];
                userObj.pos_head = [head_pos_x, head_pos_y, head_pos_z];
                userObj.pos_hand_L = [hand_L_pos_x, hand_L_pos_y, hand_L_pos_z];
                userObj.pos_hand_R = [hand_R_pos_x, hand_R_pos_y, hand_R_pos_z];

                userObj.rot_root = [root_rot_x, root_rot_y, root_rot_z, root_rot_w];
                userObj.rot_head = [head_rot_x, head_rot_y, head_rot_z, head_rot_w];
                userObj.rot_hand_L = [hand_L_rot_x, hand_L_rot_y, hand_L_rot_z, hand_L_rot_w];
                userObj.rot_hand_R = [hand_R_rot_x, hand_R_rot_y, hand_R_rot_z, hand_L_rot_w];

                userObj.message = message;

                return userObj;
            }

            function map(value, in_min, in_max, out_min, out_max, doClamp)
            {
                let val = (value - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
                if (doClamp) {
                    val = Math.min( Math.max(val, out_min), out_max );
                }
                return val;
            }

            function lerp(start, end, percent)
            {
                return (start + percent * (end - start));
            }

            socket.on("connect", (userData) => {
                socket.emit("newUser");
            });

            socket.on("usersData", (data) => {
                usersArr = [...data.items];

				//add any users already present before we start updating them
                if ( userID !== "" && initialized === false ) {
                    for (let i = 0; i < usersArr.length; i++) {
                        addUser(usersArr[i]);
                    }
                    initialized = true;	//lets not do this more than once ;)
                }
            });

            socket.on("connection_setID", (userData) => {
                if ( userID === "" ) {
                    userID = userData.id;
                    console.log( "id received: " + userID );
                }
            });

            socket.on("user_connect", (userData) => {
                console.log("user_connect: " + userData.id);
                addUser(userData);
            });

            socket.on("user_disconnect", (userData) => {
                console.log("user_disconnect: " + userData.id);
                removeUser(userData);
            });

            function removeUser(userObj) 
            {
                let userElemArr = $(".userElem").toArray();
                for (let i = userElemArr.length; i >= 0; i--) {
                    let elem = $(userElemArr[i]);
                    if ( elem.attr("id") === userObj.id ) {
                        elem.remove();
                        break;
                    }
                }
            }

            function addUser(userObj) 
            {
                let newElem = document.createElement('div');
                $(newElem).attr("id", userObj.id);
                $(newElem).addClass("userElem");
                $(newElem).css("background-color", "rgb(" + userObj.color[R] + "," + userObj.color[G] + "," + userObj.color[B] + ")");
                $(newElem).appendTo("#Display");
            }

            //doc ready, let's send our movement
            $(document).ready(function () {
                //
                //start mouse /touch events stuff from https://www.safaribooksonline.com/blog/2012/04/18/mapping-mouse-events-and-touch-events-onto-a-single-event/ 
                //
                TouchMouseEvent = {
                    DOWN: "touchmousedown",
                    UP: "touchmouseup",
                    MOVE: "touchmousemove"
                }

                let normalizeEvent = (type, original, x, y) => {
                    return $.Event(type, {
                                        pageX: x,
                                        pageY: y,
                                        originalEvent: original
                                    });
                }

                let onMouseEvent = (event) => {
                    let type;
            
                    switch (event.type) {
                        case "mousedown": type = TouchMouseEvent.DOWN; break;
                        case "mouseup":   type = TouchMouseEvent.UP;   break;
                        case "mousemove": type = TouchMouseEvent.MOVE; break;
                        default:
                            return;
                    }
            
                    const touchMouseEvent = normalizeEvent(type, event, event.pageX, event.pageY);
                    $(event.target).trigger(touchMouseEvent);
                }

                let onTouchEvent = (event) => {
                    let type;

                    switch (event.type) {
                        case "touchstart": type = TouchMouseEvent.DOWN; break;
                        case "touchend":   type = TouchMouseEvent.UP;   break;
                        case "touchmove":  type = TouchMouseEvent.MOVE; break;
                        default:
                            return;
                    }

                    const touch = event.originalEvent.touches[0];
                    let touchMouseEvent;

                    if (type == TouchMouseEvent.UP)
                        touchMouseEvent = normalizeEvent(type, event, null, null);
                    else
                        touchMouseEvent = normalizeEvent(type, event, touch.pageX, touch.pageY);

                    event.preventDefault();
                    $(event.target).trigger(touchMouseEvent);
                }

                let jQueryDocument = $(document);
                if ("ontouchstart" in window) {
                    jQueryDocument.on("touchstart", onTouchEvent);
                    jQueryDocument.on("touchmove", onTouchEvent);
                    jQueryDocument.on("touchend", onTouchEvent);
                } else {
                    jQueryDocument.on("mousedown", onMouseEvent);
                    jQueryDocument.on("mouseup", onMouseEvent);
                    jQueryDocument.on("mousemove", onMouseEvent);
                }

                //
                //end mouse /touch events stuff from https://www.safaribooksonline.com/blog/2012/04/18/mapping-mouse-events-and-touch-events-onto-a-single-event/ 
                //
                let mouseTouchDown = false;
                let mouseTouchDrag = (event) => {
                    if ( userID !== "" && mouseTouchDown ) {
                        const elem          = $("#Display");
                        const position      = elem.position();
                        const elemLeft      = position.left;
                        const elemRight     = elemLeft + elem.width();
                        const elemTop       = position.top;
                        const elemBottom    = elemTop + elem.height();
                        const userElem_HW   = $(".userElem").first().width() * 0.5;
                        const userElem_HH   = $(".userElem").first().height() * 0.5;
                        const mappedX       = map(event.pageX, elemLeft + userElem_HW, elemRight - userElem_HW, 0.0, 1.0, true);
                        const mappedY       = map(1.48, 0.0, 5.0, 0.0, 1.0, true);
                        const mappedZ       = map(event.pageY, elemTop + userElem_HH, elemBottom - userElem_HH, 0.0, 1.0, true);
                        const dataObj       = getUserObj(   userID,
                                                            0, 0, 0,
                                                            0.0, 0.0, 0.0, mappedX, mappedY, mappedZ, mappedX + 0.07, mappedY - 0.18, mappedZ, mappedX - 0.07, mappedY - 0.18, mappedZ,
                                                            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                                            "");
                        
                        socket.emit("transformUpdate", dataObj);
                    }
                };

                $("#Display").on(TouchMouseEvent.UP, (event) => { mouseTouchDown = false; });
                $("#Display").on(TouchMouseEvent.DOWN, (event) => { mouseTouchDown = true; });
                $("#Display").on(TouchMouseEvent.MOVE, mouseTouchDrag);

                //"game loop" update/draw code
                setInterval(update, 1000/60);
                function update() 
                {
               		for ( let i = 0; i < usersArr.length; i++ ) {
                    	let userObj                 = usersArr[i];

                       	//first check if there is element exist, and update if so
                       	$(".userElem").each( (index, obj) => {
                            let userElem = $(obj);
                            if ( userElem.attr("id") === userObj.id ) {
                                const scalar_x = $("#Display").width() - $(".userElem").first().width();
                                const scalar_y = $("#Display").height() - $(".userElem").first().height();
                                const oldX = parseInt(userElem.css("left"), 10); //need tyo use parseInt with base10 to remove 'px' given by css attr. call
                                const oldY = parseInt(userElem.css("top"), 10);
                                const newX = lerp(oldX, userObj.pos_head[X] * scalar_x, LERP_VAL);
                                const newY = lerp(oldY, userObj.pos_head[Z] * scalar_y, LERP_VAL);
                                userElem.css("left", newX);
                                userElem.css("top", newY);
                            }
                     	});
                      }
                      
                      //now check for collisions with "this" user
                      let userDims      = {width:0, height:0, x:0, y:0};
                      let pillarDims    = {width:0, height:0, x:0, y:0};

                      $(".userElem").each( (index_u, obj_u) => {
                            let userElem = $(obj_u);
                            if ( userElem.attr("id") === userID ) {
                                userDims.width  = userElem.width();
                                userDims.height = userElem.height();
                                userDims.x      = userElem.offset().left + userDims.width/2;
                                userDims.y      = userElem.offset().top + userDims.height/2;

                                $(".pillarButton").each( (index_p, obj_p) => {
                                    let pillarElem = $(obj_p);
                                    pillarDims.width  = pillarElem.width();
                                    pillarDims.height = pillarElem.height();
                                    pillarDims.x      = pillarElem.offset().left + pillarDims.width/2;
                                    pillarDims.y      = pillarElem.offset().top + pillarDims.height/2;

                                    if (    ( Math.abs(userDims.x - pillarDims.x) <  userDims.width/2 + pillarDims.width/2 ) &&
                                            ( Math.abs(userDims.y - pillarDims.y) <  userDims.height/2 + pillarDims.height/2 ) 
                                    ){
                                        pillarElem.css( "background-color", "rgba(233, 143, 143, 0.796)");
                                    }
                                    else {
                                        pillarElem.css( "background-color", "rgba(250, 15, 15, 0.796)");
                                    }
                                });
                                return false;;
                            }
                     	});
             	}

              	//close event
               	window.onbeforeunload = function () {
                	//event called before page closes
                  	return "Do you really want to close?";
              	};
            });

        </script>
    </body>
</html>
